<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG Path Packet Animation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            position: relative;
        }
        
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        svg {
            border: 1px solid #ddd;
            background-color: white;
            display: block;
            margin-bottom: 20px;
        }
        
        #svgPath {
            cursor: pointer;
            stroke: #333;
            stroke-width: 3;
            fill: none;
        }
        
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        #startBtn {
            background-color: #4CAF50;
        }
        
        #pauseBtn {
            background-color: #ff9800;
        }
        
        #restartBtn {
            background-color: #2196F3;
        }
        
        .dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 500px;
            max-width: 90%;
        }
        
        .dialog h2 {
            margin-top: 0;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        table, th, td {
            border: 1px solid #ddd;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
        }
        
        th {
            background-color: #f2f2f2;
        }
        
        .delete-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .description-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            max-width: 80%;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1001;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SVG Path Packet Animation</h1>
        <p>Double-click on the path to add animated packets</p>
        
        <svg id="svg" width="800" height="300" viewBox="0 0 800 300">
            <!-- Curved path example -->
            <path id="svgPath" d="M100,150 C250,50 550,250 700,150"></path>
        </svg>
        
        <div class="controls">
            <button id="startBtn" disabled>Start Animation</button>
            <button id="pauseBtn" disabled>Pause Animation</button>
            <button id="restartBtn" disabled>Restart Animation</button>
        </div>
    </div>
    
    <div class="overlay" id="overlay"></div>
    
    <div class="dialog" id="dialog">
        <div class="tabs">
            <div class="tab active" data-tab="addPacket">Add Packet</div>
            <div class="tab" data-tab="listPackets">List Packets</div>
        </div>
        
        <div class="tab-content active" id="addPacketTab">
            <h2>Add Packet</h2>
            <div class="form-group">
                <label for="packetId">Packet ID:</label>
                <input type="text" id="packetId" placeholder="Enter a unique ID">
            </div>
            
            <div class="form-group">
                <label for="packetColor">Packet Color:</label>
                <input type="color" id="packetColor" value="#ff0000">
            </div>
            
            <div class="form-group">
                <label for="packetSize">Packet Size:</label>
                <input type="number" id="packetSize" min="5" max="50" value="15">
            </div>
            
            <div class="form-group">
                <label for="packetDirection">Direction:</label>
                <select id="packetDirection">
                    <option value="start">Start to End</option>
                    <option value="end">End to Start</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="packetDescription">Description:</label>
                <textarea id="packetDescription" placeholder="Enter a description for this packet"></textarea>
            </div>
            
            <div class="form-group">
                <label for="animationDuration">Animation Duration (ms):</label>
                <input type="number" id="animationDuration" min="500" max="10000" value="2000">
            </div>
            
            <div class="form-group">
                <label for="animationRepeat">Animation Repeat:</label>
                <select id="animationRepeat">
                    <option value="1">Once</option>
                    <option value="-1">Loop Forever</option>
                    <option value="3">3 Times</option>
                    <option value="5">5 Times</option>
                    <option value="10">10 Times</option>
                </select>
            </div>
            
            <div class="dialog-buttons">
                <button id="cancelBtn">Cancel</button>
                <button id="addPacketBtn">Add Packet</button>
            </div>
        </div>
        
        <div class="tab-content" id="listPacketsTab">
            <h2>Packet List</h2>
            <div id="packetTable">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Color</th>
                            <th>Size</th>
                            <th>Direction</th>
                            <th>Description</th>
                            <th>Duration</th>
                            <th>Repeat</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="packetTableBody">
                        <!-- Packets will be listed here -->
                    </tbody>
                </table>
            </div>
            
            <div class="dialog-buttons">
                <button id="closeListBtn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Description box that will appear at the bottom of the screen -->
    <div id="descriptionBox" class="description-box"></div>

    <script>
        class PacketAnimationManager {
            constructor() {
                // SVG Elements
                this.svg = document.getElementById('svg');
                this.path = document.getElementById('svgPath');
                this.pathLength = this.path.getTotalLength();
                
                // Dialog Elements
                this.dialog = document.getElementById('dialog');
                this.overlay = document.getElementById('overlay');
                this.descriptionBox = document.getElementById('descriptionBox');
                
                // Form Elements
                this.packetIdInput = document.getElementById('packetId');
                this.packetColorInput = document.getElementById('packetColor');
                this.packetSizeInput = document.getElementById('packetSize');
                this.packetDirectionInput = document.getElementById('packetDirection');
                this.packetDescriptionInput = document.getElementById('packetDescription');
                this.animationDurationInput = document.getElementById('animationDuration');
                this.animationRepeatInput = document.getElementById('animationRepeat');
                
                // Buttons
                this.startBtn = document.getElementById('startBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.restartBtn = document.getElementById('restartBtn');
                this.cancelBtn = document.getElementById('cancelBtn');
                this.addPacketBtn = document.getElementById('addPacketBtn');
                this.closeListBtn = document.getElementById('closeListBtn');
                
                // Tabs
                this.tabs = document.querySelectorAll('.tab');
                this.tabContents = document.querySelectorAll('.tab-content');
                
                // Table
                this.packetTableBody = document.getElementById('packetTableBody');
                
                // State variables
                this.packets = [];
                this.animationState = 'stopped'; // 'running', 'paused', 'stopped'
                this.activeDescriptions = new Set(); // Track active packets for descriptions
                
                // Initialize
                this.bindEvents();
            }
            
            bindEvents() {
                // Path double-click event
                this.path.addEventListener('dblclick', () => this.openDialog());
                
                // Button events
                this.startBtn.addEventListener('click', () => this.startAnimation());
                this.pauseBtn.addEventListener('click', () => this.pauseAnimation());
                this.restartBtn.addEventListener('click', () => this.restartAnimation());
                this.cancelBtn.addEventListener('click', () => this.closeDialog());
                this.addPacketBtn.addEventListener('click', () => this.addPacket());
                this.closeListBtn.addEventListener('click', () => this.closeDialog());
                
                // Tab events
                this.tabs.forEach(tab => {
                    tab.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
                });
                
                // Close dialog when clicking overlay
                this.overlay.addEventListener('click', () => this.closeDialog());
            }
            
            openDialog() {
                this.dialog.style.display = 'block';
                this.overlay.style.display = 'block';
                this.updatePacketTable();
            }
            
            closeDialog() {
                this.dialog.style.display = 'none';
                this.overlay.style.display = 'none';
            }
            
            switchTab(tabId) {
                // Update tab active state
                this.tabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === tabId);
                });
                
                // Update tab content visibility
                this.tabContents.forEach(content => {
                    content.classList.toggle('active', content.id === tabId + 'Tab');
                });
                
                if (tabId === 'listPackets') {
                    this.updatePacketTable();
                }
            }
            
            updatePacketTable() {
                this.packetTableBody.innerHTML = '';
                
                if (this.packets.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="8" style="text-align: center;">No packets added yet</td>';
                    this.packetTableBody.appendChild(row);
                    return;
                }
                
                this.packets.forEach((packet, index) => {
                    const row = document.createElement('tr');
                    
                    // Format the repeat display
                    let repeatText;
                    if (packet.repeat === -1) {
                        repeatText = 'Loop';
                    } else if (packet.repeat === 1) {
                        repeatText = 'Once';
                    } else {
                        repeatText = `${packet.repeat} Times`;
                    }
                    
                    // Truncate description if it's too long
                    const descriptionDisplay = packet.description ? 
                        (packet.description.length > 30 ? 
                            packet.description.substring(0, 30) + '...' : 
                            packet.description) :
                        '-';
                    
                    row.innerHTML = `
                        <td>${packet.id}</td>
                        <td style="background-color: ${packet.color}; color: ${this.getContrastColor(packet.color)}">${packet.color}</td>
                        <td>${packet.size}px</td>
                        <td>${packet.direction === 'start' ? 'Start to End' : 'End to Start'}</td>
                        <td title="${packet.description || ''}">${descriptionDisplay}</td>
                        <td>${packet.duration}ms</td>
                        <td>${repeatText}</td>
                        <td>
                            <button class="delete-btn" data-index="${index}">Delete</button>
                        </td>
                    `;
                    this.packetTableBody.appendChild(row);
                });
                
                // Add event listeners to delete buttons
                const deleteButtons = document.querySelectorAll('.delete-btn');
                deleteButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        this.deletePacket(index);
                    });
                });
            }
            
            getContrastColor(hexColor) {
                // Convert hex to RGB
                const r = parseInt(hexColor.substr(1, 2), 16);
                const g = parseInt(hexColor.substr(3, 2), 16);
                const b = parseInt(hexColor.substr(5, 2), 16);
                
                // Calculate luminance using ITU-R BT.709
                const luminance = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
                
                // Return black or white depending on luminance
                return luminance > 0.5 ? '#000000' : '#ffffff';
            }
            
            addPacket() {
                const id = this.packetIdInput.value.trim();
                const color = this.packetColorInput.value;
                const size = parseInt(this.packetSizeInput.value);
                const direction = this.packetDirectionInput.value;
                const description = this.packetDescriptionInput.value.trim();
                const duration = parseInt(this.animationDurationInput.value);
                const repeat = parseInt(this.animationRepeatInput.value);
                
                // Validate input
                if (!id) {
                    alert('Please enter a Packet ID');
                    return;
                }
                
                // Check for duplicate ID
                if (this.packets.some(packet => packet.id === id)) {
                    alert('Packet ID already exists. Please use a unique ID.');
                    return;
                }
                
                // Create packet object
                const packet = {
                    id,
                    color,
                    size,
                    direction,
                    description,
                    duration,
                    repeat,
                    element: null,
                    animation: null,
                    state: 'stopped'
                };
                
                // Create SVG element for the packet
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('id', `packet-${id}`);
                rect.setAttribute('width', size);
                rect.setAttribute('height', size);
                rect.setAttribute('fill', color);
                rect.setAttribute('visibility', 'hidden'); // Hidden initially
                
                // Position at start or end of path
                const pathPoint = direction === 'start' ? 
                    this.path.getPointAtLength(0) : 
                    this.path.getPointAtLength(this.pathLength);
                
                rect.setAttribute('x', pathPoint.x - size / 2);
                rect.setAttribute('y', pathPoint.y - size / 2);
                
                // Add to SVG
                this.svg.appendChild(rect);
                
                // Store the element reference
                packet.element = rect;
                
                // Create animation using anime.js motion path
                this.createPathAnimation(packet);
                
                // Add to packets array
                this.packets.push(packet);
                
                // Update buttons
                this.startBtn.disabled = false;
                
                // Reset form
                this.packetIdInput.value = '';
                this.packetDescriptionInput.value = '';
                
                // Close dialog
                this.closeDialog();
            }
            
            createPathAnimation(packet) {
                const pathNode = this.path;
                const rect = packet.element;
                const size = packet.size;
                const duration = packet.duration;
                const direction = packet.direction;
                const repeat = packet.repeat;
                
                // Create SVG points for motion
                const pathLength = this.pathLength;
                let motionPath = [];
                
                // Create points along the path for animation
                const numPoints = 100; // More points = smoother animation
                for (let i = 0; i <= numPoints; i++) {
                    const point = pathNode.getPointAtLength(
                        direction === 'start' ? 
                            (i / numPoints) * pathLength : 
                            (1 - (i / numPoints)) * pathLength
                    );
                    motionPath.push({ x: point.x - size / 2, y: point.y - size / 2 });
                }
                
                // Create the animation
                const animation = anime({
                    targets: rect,
                    translateX: 0, // Reset any previous translations
                    translateY: 0,
                    x: motionPath.map(p => p.x),
                    y: motionPath.map(p => p.y),
                    duration: duration,
                    easing: 'linear',
                    autoplay: false,
                    loop: repeat,
                    begin: () => {
                        rect.setAttribute('visibility', 'visible');
                        this.showDescription(packet);
                    },
                    complete: () => {
                        rect.setAttribute('visibility', 'hidden');
                        packet.state = 'stopped';
                        this.hideDescription(packet);
                        this.checkAllAnimationsComplete();
                    }
                });
                
                packet.animation = animation;
            }
            
            showDescription(packet) {
                if (packet.description) {
                    this.activeDescriptions.add(packet.id);
                    this.updateDescriptionBox();
                }
            }
            
            hideDescription(packet) {
                if (packet.description) {
                    this.activeDescriptions.delete(packet.id);
                    this.updateDescriptionBox();
                }
            }
            
            updateDescriptionBox() {
                if (this.activeDescriptions.size === 0) {
                    // No active packets with descriptions
                    this.descriptionBox.style.opacity = '0';
                    return;
                }
                
                // Collect all active descriptions
                let descriptions = [];
                for (const packetId of this.activeDescriptions) {
                    const packet = this.packets.find(p => p.id === packetId);
                    if (packet && packet.description) {
                        descriptions.push(`<span style="color:${packet.color}">${packet.id}</span>: ${packet.description}`);
                    }
                }
                
                // Update description box
                this.descriptionBox.innerHTML = descriptions.join('<br>');
                this.descriptionBox.style.opacity = '1';
            }
            
            deletePacket(index) {
                const packet = this.packets[index];
                
                // Remove from active descriptions if present
                this.activeDescriptions.delete(packet.id);
                this.updateDescriptionBox();
                
                // Remove SVG element
                if (packet.element) {
                    this.svg.removeChild(packet.element);
                }
                
                // Remove from packets array
                this.packets.splice(index, 1);
                
                // Update UI
                this.updatePacketTable();
                
                // Update buttons
                if (this.packets.length === 0) {
                    this.startBtn.disabled = true;
                    this.pauseBtn.disabled = true;
                    this.restartBtn.disabled = true;
                    this.animationState = 'stopped';
                }
            }
            
            startAnimation() {
                if (this.animationState === 'running') return;
                
                this.packets.forEach(packet => {
                    if (packet.state !== 'running') {
                        packet.animation.play();
                        packet.state = 'running';
                    }
                });
                
                this.animationState = 'running';
                this.startBtn.disabled = true;
                this.pauseBtn.disabled = false;
                this.restartBtn.disabled = false;
            }
            
            pauseAnimation() {
                if (this.animationState !== 'running') return;
                
                this.packets.forEach(packet => {
                    if (packet.state === 'running') {
                        packet.animation.pause();
                        packet.state = 'paused';
                    }
                });
                
                this.animationState = 'paused';
                this.startBtn.disabled = false;
                this.pauseBtn.disabled = true;
            }
            
            restartAnimation() {
                this.packets.forEach(packet => {
                    packet.animation.restart();
                    packet.state = 'running';
                });
                
                this.animationState = 'running';
                this.startBtn.disabled = true;
                this.pauseBtn.disabled = false;
            }
            
            checkAllAnimationsComplete() {
                const allStopped = this.packets.every(packet => packet.state === 'stopped');
                
                if (allStopped) {
                    this.animationState = 'stopped';
                    this.startBtn.disabled = false;
                    this.pauseBtn.disabled = true;
                    this.restartBtn.disabled = false;
                }
            }
        }
        
        // Initialize when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            const packetManager = new PacketAnimationManager();
        });
    </script>
</body>
</html>